<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vZEV Abrechnung für Nachbarn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="file"]::file-selector-button {
            @apply bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg cursor-pointer transition-colors duration-300 hover:bg-indigo-700;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">vZEV Abrechnung für Nachbarn</h1>
            <p class="text-gray-500 mt-2">Laden Sie die Lastgangdaten aller Teilnehmer hoch.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-gray-50 p-4 rounded-lg border">
            <div>
                <label for="price-buy" class="block text-sm font-medium text-gray-700">Netzbezug (CHF/kWh)</label>
                <input type="number" id="price-buy" value="0.25" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div>
                <label for="price-sell" class="block text-sm font-medium text-gray-700">Einspeisung (CHF/kWh)</label>
                <input type="number" id="price-sell" value="0.10" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div>
                <label for="price-neighbor" class="block text-sm font-medium text-gray-700">Nachbarn (CHF/kWh)</label>
                <input type="number" id="price-neighbor" value="0.18" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
        </div>

        <div class="mb-6 bg-gray-50 p-4 rounded-lg border">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Teilnehmer konfigurieren</h3>
            <div id="participants-config" class="space-y-3">
                </div>
            <button id="add-participant-btn" class="mt-4 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300">
                + Teilnehmer hinzufügen
            </button>
        </div>

        <div class="mb-6">
            <label for="file-upload" class="block text-sm font-medium text-gray-700 mb-2">CSV-Dateien auswählen:</label>
            <input id="file-upload" type="file" multiple accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:border-0 file:rounded-lg">
        </div>

        <div class="text-center mb-8">
            <button id="process-btn" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 duration-300">
                Abrechnung berechnen
            </button>
        </div>

        <div id="results-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6 hidden">
            </div>

    </div>

    <script>
        // --- DOM Element References ---
        const fileUpload = document.getElementById('file-upload');
        const processBtn = document.getElementById('process-btn');
        const priceBuyInput = document.getElementById('price-buy');
        const priceSellInput = document.getElementById('price-sell');
        const priceNeighborInput = document.getElementById('price-neighbor');
        const resultsContainer = document.getElementById('results-container');
        const participantsConfig = document.getElementById('participants-config');
        const addParticipantBtn = document.getElementById('add-participant-btn');

        // --- Constants for Data Processing ---
        const CONSUMPTION_CODE = '1-1:1.29.0*255'; // Netzbezug
        const PRODUCTION_CODE = '1-1:2.29.0*255'; // Netzeinspeisung (Überschuss)
        
        // --- Dynamic Participants List ---
        let participants = [];
        let participantIdCounter = 0;
        
        // Initialize with default participants
        function initializeDefaultParticipants() {
            // Example: 1 Producer/Consumer and 2 Consumers
            addParticipant('Produzent/Konsument', 'CH1035501234500000000000000000859', true, true);
            addParticipant('Konsument 1', '', false, true);
            addParticipant('Konsument 2', '', false, true);
        }
        
        function addParticipant(name = '', meterId = '', isProducer = false, isConsumer = true) {
            const id = participantIdCounter++;
            participants.push({
                id,
                name: name || `Teilnehmer ${id + 1}`,
                meterId: meterId || '',
                isProducer,
                isConsumer
            });
            renderParticipantConfig();
        }
        
        function removeParticipant(id) {
            participants = participants.filter(p => p.id !== id);
            renderParticipantConfig();
        }
        
        function updateParticipant(id, field, value) {
            const participant = participants.find(p => p.id === id);
            if (participant) {
                if (field === 'isProducer' || field === 'isConsumer') {
                    participant[field] = value;
                } else {
                    participant[field] = value;
                }
            }
        }
        
        function renderParticipantConfig() {
            participantsConfig.innerHTML = participants.map(p => `
                <div class="border rounded-lg p-3 bg-white" data-participant-id="${p.id}">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-2 items-center">
                        <input type="text" 
                            value="${p.name}" 
                            onchange="updateParticipant(${p.id}, 'name', this.value)"
                            placeholder="Name"
                            class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="text" 
                            value="${p.meterId}" 
                            onchange="updateParticipant(${p.id}, 'meterId', this.value)"
                            placeholder="Zähler-ID"
                            class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 col-span-2">
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="checkbox" 
                                    ${p.isProducer ? 'checked' : ''}
                                    onchange="updateParticipant(${p.id}, 'isProducer', this.checked)"
                                    class="mr-2 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <span class="text-sm">Produzent</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" 
                                    ${p.isConsumer ? 'checked' : ''}
                                    onchange="updateParticipant(${p.id}, 'isConsumer', this.checked)"
                                    class="mr-2 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <span class="text-sm">Konsument</span>
                            </label>
                        </div>
                        <button onclick="removeParticipant(${p.id})" 
                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors">
                            Entfernen
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        addParticipantBtn.addEventListener('click', () => addParticipant());
        
        // Initialize with default participants
        initializeDefaultParticipants();

        processBtn.addEventListener('click', async () => {
            if (fileUpload.files.length === 0) {
                displayMessage('Bitte wählen Sie die CSV-Dateien aus.');
                return;
            }

            resultsContainer.classList.remove('hidden');
            resultsContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">Dateien werden verarbeitet...</p>';
            
            try {
                const fileContents = await Promise.all(Array.from(fileUpload.files).map(f => f.text()));
                const timeSeriesData = structureDataByTime(fileContents);
                const results = calculateVZEV(timeSeriesData);
                const prices = {
                    buy: parseFloat(priceBuyInput.value) || 0,
                    sell: parseFloat(priceSellInput.value) || 0,
                    neighbor: parseFloat(priceNeighborInput.value) || 0,
                };
                displayResults(results, prices);

            } catch (error) {
                console.error('Fehler bei der Verarbeitung:', error);
                displayMessage('Ein Fehler ist aufgetreten. Details in der Konsole.');
            }
        });

        function structureDataByTime(fileContents) {
            const dataMap = new Map();
            const meterIdToParticipantId = {};
            
            // Map known meter IDs to participants
            participants.forEach(p => {
                if (p.meterId) {
                    meterIdToParticipantId[p.meterId] = p.id;
                }
            });

            // Discover all meter IDs in files
            const availableMeterIds = new Set();
            fileContents.forEach(content => {
                const lines = content.split('\n').slice(1); // Skip header
                lines.forEach(line => {
                    const delimiter = line.includes(';') ? ';' : ',';
                    const meterId = line.split(delimiter)[0];
                    if (meterId && meterId.startsWith('CH')) {
                        availableMeterIds.add(meterId);
                    }
                });
            });
            
            // Assign remaining meter IDs to participants without one
            const unassignedMeterIds = Array.from(availableMeterIds).filter(id => !Object.keys(meterIdToParticipantId).includes(id));
            const participantsWithoutMeterId = participants.filter(p => !p.meterId);
            
            participantsWithoutMeterId.forEach((p, index) => {
                if (index < unassignedMeterIds.length) {
                    const meterId = unassignedMeterIds[index];
                    p.meterId = meterId; // Update participant object
                    meterIdToParticipantId[meterId] = p.id;
                }
            });

            // Process files
            fileContents.forEach(content => {
                const lines = content.split('\n').filter(line => line.trim());
                lines.forEach(line => {
                    const delimiter = line.includes(';') ? ';' : ',';
                    const cols = line.split(delimiter);
                    if (cols.length < 5) return;

                    const meterId = cols[0];
                    const participantId = meterIdToParticipantId[meterId];
                    if (participantId === undefined) return; // Skip data for unknown meters

                    const typeCode = cols[1];
                    const date = cols[3];
                    const values = cols.slice(4).map(v => parseFloat(v.replace(',', '.')) || 0);

                    if (!dataMap.has(date)) dataMap.set(date, {});
                    const dayData = dataMap.get(date);

                    if (!dayData[participantId]) {
                        dayData[participantId] = {
                            feedIn: Array(96).fill(0),
                            import: Array(96).fill(0)
                        };
                    }

                    if (typeCode === PRODUCTION_CODE) {
                        dayData[participantId].feedIn = values;
                    } else if (typeCode === CONSUMPTION_CODE) {
                        dayData[participantId].import = values;
                    }
                });
            });
            return dataMap;
        }

        function calculateVZEV(timeSeriesData) {
            const participantResults = {};
            participants.forEach(p => {
                participantResults[p.id] = {
                    name: p.name,
                    meterId: p.meterId,
                    isProducer: p.isProducer,
                    isConsumer: p.isConsumer,
                    totalSurplus: 0, // Energy sent to community/grid
                    totalConsumption: 0, // Energy consumed from grid or community
                    gridFeedIn: 0,
                    gridImport: 0,
                    soldTo: {}, // Detailed tracking: { consumerId: amount }
                    boughtFrom: {} // Detailed tracking: { producerId: amount }
                };
            });

            for (const dayData of timeSeriesData.values()) {
                for (let i = 0; i < 96; i++) {
                    let totalAvailableProduction = 0;
                    const producerSurplus = {}; // { producerId: surplus }
                    
                    let totalDemand = 0;
                    const consumerDemands = {}; // { consumerId: demand }

                    // Step 1: Gather surplus from producers and demand from consumers for this interval
                    participants.forEach(p => {
                        const pData = dayData[p.id];
                        if (!pData) return;

                        if (p.isProducer) {
                            const surplus = pData.feedIn[i] || 0;
                            if (surplus > 0) {
                                producerSurplus[p.id] = surplus;
                                totalAvailableProduction += surplus;
                            }
                        }
                        if (p.isConsumer) {
                            const demand = pData.import[i] || 0;
                            if (demand > 0) {
                                consumerDemands[p.id] = demand;
                                totalDemand += demand;
                            }
                        }
                    });

                    // Step 2: Distribute available energy
                    if (totalAvailableProduction > 0 && totalDemand > 0) {
                        if (totalAvailableProduction >= totalDemand) {
                            // More production than demand -> all demand is covered by community
                            for (const [consumerId, demand] of Object.entries(consumerDemands)) {
                                // For this consumer, attribute where the energy came from
                                for (const [producerId, surplus] of Object.entries(producerSurplus)) {
                                    const proportion = surplus / totalAvailableProduction;
                                    const amountFromThisProducer = demand * proportion;
                                    
                                    participantResults[consumerId].boughtFrom[producerId] = (participantResults[consumerId].boughtFrom[producerId] || 0) + amountFromThisProducer;
                                    participantResults[producerId].soldTo[consumerId] = (participantResults[producerId].soldTo[consumerId] || 0) + amountFromThisProducer;
                                }
                            }
                            // Attribute leftover to grid feed-in for each producer
                            const leftover = totalAvailableProduction - totalDemand;
                            for (const [producerId, surplus] of Object.entries(producerSurplus)) {
                                const proportion = surplus / totalAvailableProduction;
                                participantResults[producerId].gridFeedIn += leftover * proportion;
                            }
                        } else { // totalAvailableProduction < totalDemand
                            // More demand than production -> all production is consumed, rest is imported
                            const coverageRatio = totalAvailableProduction / totalDemand;
                            for (const [consumerId, demand] of Object.entries(consumerDemands)) {
                                const receivedFromCommunity = demand * coverageRatio;
                                const importedFromGrid = demand - receivedFromCommunity;
                                participantResults[consumerId].gridImport += importedFromGrid;

                                // Attribute the community energy to producers
                                for (const [producerId, surplus] of Object.entries(producerSurplus)) {
                                    const proportion = surplus / totalAvailableProduction;
                                    const amountFromThisProducer = receivedFromCommunity * proportion;

                                    participantResults[consumerId].boughtFrom[producerId] = (participantResults[consumerId].boughtFrom[producerId] || 0) + amountFromThisProducer;
                                    participantResults[producerId].soldTo[consumerId] = (participantResults[producerId].soldTo[consumerId] || 0) + amountFromThisProducer;
                                }
                            }
                        }
                    } else if (totalAvailableProduction > 0) { // Production, no demand
                        for (const [producerId, surplus] of Object.entries(producerSurplus)) {
                            participantResults[producerId].gridFeedIn += surplus;
                        }
                    } else if (totalDemand > 0) { // Demand, no production
                        for (const [consumerId, demand] of Object.entries(consumerDemands)) {
                            participantResults[consumerId].gridImport += demand;
                        }
                    }
                }
            }

            // Final tally
            Object.values(participantResults).forEach(res => {
                const p = participants.find(p => p.name === res.name);
                if (p && p.isProducer) {
                    const totalSold = Object.values(res.soldTo).reduce((sum, val) => sum + val, 0);
                    res.totalSurplus = totalSold + res.gridFeedIn;
                }
                if (p && p.isConsumer) {
                    const totalBought = Object.values(res.boughtFrom).reduce((sum, val) => sum + val, 0);
                    res.totalConsumption = totalBought + res.gridImport;
                }
            });

            return participantResults;
        }

        function displayResults(results, prices) {
            const formatKwh = (num) => (num || 0).toFixed(3).replace('.', ',');
            const formatChf = (num) => (num || 0).toFixed(2).replace('.', ',');
            
            resultsContainer.innerHTML = '';
            
            Object.values(results).forEach(participant => {
                const isProducer = participant.isProducer;
                const isConsumer = participant.isConsumer;
                const bgColor = isProducer ? 'bg-green-800' : 'bg-blue-900';
                
                const totalSoldToOthers = Object.values(participant.soldTo).reduce((a, b) => a + b, 0);
                const totalBoughtFromOthers = Object.values(participant.boughtFrom).reduce((a, b) => a + b, 0);

                const incomeFromNeighbors = totalSoldToOthers * prices.neighbor;
                const incomeFromGrid = participant.gridFeedIn * prices.sell;
                const costFromNeighbors = totalBoughtFromOthers * prices.neighbor;
                const costFromGrid = participant.gridImport * prices.buy;
                const totalIncome = incomeFromNeighbors + incomeFromGrid;
                const totalCost = costFromNeighbors + costFromGrid;
                const netResult = totalIncome - totalCost;
                
                let soldToDetails = '';
                if (isProducer && Object.keys(participant.soldTo).length > 0) {
                    soldToDetails += '<ul class="text-xs mt-1 pl-4 list-disc list-inside text-gray-400">';
                    for (const [consumerId, amount] of Object.entries(participant.soldTo)) {
                        const consumerName = results[consumerId]?.name || `ID ${consumerId}`;
                        soldToDetails += `<li>${consumerName}: ${formatKwh(amount)} kWh</li>`;
                    }
                    soldToDetails += '</ul>';
                }

                let boughtFromDetails = '';
                if (isConsumer && Object.keys(participant.boughtFrom).length > 0) {
                    boughtFromDetails += '<ul class="text-xs mt-1 pl-4 list-disc list-inside text-gray-400">';
                    for (const [producerId, amount] of Object.entries(participant.boughtFrom)) {
                        const producerName = results[producerId]?.name || `ID ${producerId}`;
                        boughtFromDetails += `<li>${producerName}: ${formatKwh(amount)} kWh</li>`;
                    }
                    boughtFromDetails += '</ul>';
                }

                const participantHtml = `
                    <div class="${bgColor} bg-opacity-90 text-white rounded-xl p-6 shadow-inner">
                        <h2 class="text-xl font-bold text-center mb-6">
                            ${participant.name} 
                            ${participant.meterId ? `(Zähler ...${participant.meterId.slice(-4)})` : ''}
                        </h2>
                        <div class="space-y-3 text-sm">
                            ${isProducer ? `
                                ${createResultRow('Gesamter Überschuss', `${formatKwh(participant.totalSurplus)} kWh`)}
                                <hr class="border-gray-600 my-2">
                                ${createResultRow('An Nachbarn verkauft', `${formatKwh(totalSoldToOthers)} kWh`, `Ertrag: ${formatChf(incomeFromNeighbors)} CHF`, soldToDetails)}
                                ${createResultRow('Ins Netz eingespeist', `${formatKwh(participant.gridFeedIn)} kWh`, `Ertrag: ${formatChf(incomeFromGrid)} CHF`)}
                            ` : ''}
                            
                            ${isConsumer ? `
                                ${isProducer ? '' : createResultRow('Gesamtverbrauch', `${formatKwh(participant.totalConsumption)} kWh`)}
                                <hr class="border-gray-600 my-2">
                                ${createResultRow('Von Nachbarn bezogen', `${formatKwh(totalBoughtFromOthers)} kWh`, `Kosten: ${formatChf(costFromNeighbors)} CHF`, boughtFromDetails)}
                                ${createResultRow('Vom Netz bezogen', `${formatKwh(participant.gridImport)} kWh`, `Kosten: ${formatChf(costFromGrid)} CHF`)}
                            ` : ''}
                            
                            <hr class="border-gray-600 my-2">
                            <div class="flex justify-between items-center py-1">
                                <span class="font-semibold">Gesamtertrag</span>
                                <span class="font-semibold">${formatChf(totalIncome)} CHF</span>
                            </div>
                            <div class="flex justify-between items-center py-1">
                                <span class="font-semibold">Gesamtkosten</span>
                                <span class="font-semibold">${formatChf(totalCost)} CHF</span>
                            </div>
                            <hr class="border-gray-600 my-2">
                            <div class="flex justify-between items-center py-1 text-base">
                                <span class="font-bold ${netResult >= 0 ? 'text-green-400' : 'text-red-400'}">Nettoergebnis</span>
                                <span class="font-bold ${netResult >= 0 ? 'text-green-400' : 'text-red-400'}">${formatChf(netResult)} CHF</span>
                            </div>
                        </div>
                    </div>
                `;
                
                resultsContainer.innerHTML += participantHtml;
            });
        }

        function createResultRow(label, value, monetaryValue = '', detailsHtml = '') {
            return `
                <div class="flex justify-between items-start py-1 border-b border-gray-700">
                    <div>
                        <span class="text-gray-300">${label}</span>
                        ${monetaryValue ? `<br><span class="text-xs text-indigo-300">${monetaryValue}</span>` : ''}
                    </div>
                    <div class="text-right">
                         <span class="font-semibold text-white">${value}</span>
                         ${detailsHtml}
                    </div>
                </div>
            `;
        }

        function displayMessage(message) {
            resultsContainer.classList.remove('hidden');
            resultsContainer.innerHTML = `<p class="text-center text-red-400 col-span-full">${message}</p>`;
        }
    </script>
</body>
</html>